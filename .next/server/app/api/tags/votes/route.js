"use strict";(()=>{var e={};e.id=144,e.ids=[144],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},506:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>_,patchFetch:()=>f,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>v,staticGenerationAsyncStorage:()=>m});var r={};s.r(r),s.d(r,{DELETE:()=>d,GET:()=>c,POST:()=>p});var o=s(9303),a=s(8716),n=s(670),i=s(7070),u=s(7982);async function p(e){try{let{module_id:t,subcategory_ids:s,session_id:r}=await e.json();if(!t||!s||!Array.isArray(s)||!r)return i.NextResponse.json({error:"缺少必要参数"},{status:400});let{data:o,error:a}=await u.O.from("tag_votes").select("subcategory_id").eq("module_id",t).eq("session_id",r);if(a)return i.NextResponse.json({error:a.message},{status:500});let n=o?.map(e=>e.subcategory_id)||[],p=s.filter(e=>!n.includes(e)).map(e=>({module_id:t,subcategory_id:e,session_id:r}));if(0===p.length)return i.NextResponse.json({message:"没有新的投票需要提交"});let{data:c,error:d}=await u.O.from("tag_votes").insert(p).select();if(d)return i.NextResponse.json({error:d.message},{status:500});return i.NextResponse.json({message:`成功提交 ${p.length} 个投票`,votes:c})}catch(e){return i.NextResponse.json({error:"Internal server error"},{status:500})}}async function c(e){try{let{searchParams:t}=new URL(e.url),s=t.get("module_id");if(!s)return i.NextResponse.json({error:"缺少 module_id 参数"},{status:400});let{data:r,error:o}=await u.O.from("tag_votes").select(`
        subcategory_id,
        tag_subcategories (
          id,
          name,
          description,
          tag_categories (
            id,
            name
          )
        )
      `).eq("module_id",s);if(o)return i.NextResponse.json({error:o.message},{status:500});let a=r?.reduce((e,t)=>{let s=t.subcategory_id;return e[s]||(e[s]={subcategory_id:s,count:0,tag_subcategories:t.tag_subcategories}),e[s].count++,e},{}),n=Object.values(a||{});return i.NextResponse.json(n)}catch(e){return i.NextResponse.json({error:"Internal server error"},{status:500})}}async function d(e){try{let{module_id:t,session_id:s}=await e.json();if(!t||!s)return i.NextResponse.json({error:"缺少必要参数"},{status:400});let{data:r,error:o}=await u.O.from("tag_votes").select("id").eq("module_id",t).eq("session_id",s);if(o)return i.NextResponse.json({error:o.message},{status:500});let{error:a,count:n}=await u.O.from("tag_votes").delete({count:"exact"}).eq("module_id",t).eq("session_id",s);if(a)return console.error("删除投票记录失败:",a),i.NextResponse.json({error:a.message},{status:500});return i.NextResponse.json({message:"投票记录已删除",deletedCount:n||0,foundCount:r?.length||0})}catch(e){return i.NextResponse.json({error:"Internal server error"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/tags/votes/route",pathname:"/api/tags/votes",filename:"route",bundlePath:"app/api/tags/votes/route"},resolvedPagePath:"/home/runner/work/rw-webapp/rw-webapp/src/app/api/tags/votes/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:v}=l,_="/api/tags/votes/route";function f(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:m})}},7982:(e,t,s)=>{s.d(t,{O:()=>n});let r=require("@supabase/supabase-js"),o="https://eguhisfzeimoivfmikgb.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVndWhpc2Z6ZWltb2l2Zm1pa2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTMzNzEsImV4cCI6MjA3MDk2OTM3MX0.3E8MD1a8SebcCo2IDQmXd9BFv18zh1213eGfZ-3EcD0",n=(0,r.createClient)(o,a);(0,r.createClient)(o,process.env.SUPABASE_SERVICE_ROLE_KEY||a)}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[276,972],()=>s(506));module.exports=r})();