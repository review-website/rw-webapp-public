"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[764],{6334:function(e,t,o){o.d(t,{z:function(){return i}});var r=o(7437),n=o(3448);let i=(0,o(2265).forwardRef)((e,t)=>{let{className:o,variant:i="primary",size:s="md",...a}=e;return(0,r.jsx)("button",{className:(0,n.cn)("inline-flex items-center justify-center rounded-md font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50",{"bg-blue-600 text-white hover:bg-blue-700":"primary"===i,"bg-gray-100 text-gray-900 hover:bg-gray-200":"secondary"===i,"border border-gray-300 bg-white text-gray-900 hover:bg-gray-50":"outline"===i,"text-gray-900 hover:bg-gray-100":"ghost"===i},{"h-8 px-3 text-sm":"sm"===s,"h-10 px-4":"md"===s,"h-12 px-6 text-lg":"lg"===s},o),ref:t,...a})});i.displayName="Button"},757:function(e,t,o){o.d(t,{Ol:function(){return a},Zb:function(){return s},aY:function(){return u},ll:function(){return l}});var r=o(7437),n=o(3448),i=o(2265);let s=(0,i.forwardRef)((e,t)=>{let{className:o,...i}=e;return(0,r.jsx)("div",{ref:t,className:(0,n.cn)("rounded-lg border bg-white shadow-sm",o),...i})});s.displayName="Card";let a=(0,i.forwardRef)((e,t)=>{let{className:o,...i}=e;return(0,r.jsx)("div",{ref:t,className:(0,n.cn)("flex flex-col space-y-1.5 p-6",o),...i})});a.displayName="CardHeader";let l=(0,i.forwardRef)((e,t)=>{let{className:o,...i}=e;return(0,r.jsx)("h3",{ref:t,className:(0,n.cn)("text-lg font-semibold leading-none tracking-tight",o),...i})});l.displayName="CardTitle";let u=(0,i.forwardRef)((e,t)=>{let{className:o,...i}=e;return(0,r.jsx)("div",{ref:t,className:(0,n.cn)("p-6 pt-0",o),...i})});u.displayName="CardContent"},3448:function(e,t,o){o.d(t,{AC:function(){return f},Fp:function(){return h},Sp:function(){return g},cn:function(){return i},i$:function(){return y},j2:function(){return a},mJ:function(){return l},p6:function(){return m},tv:function(){return u},u3:function(){return c},xV:function(){return d},xv:function(){return s}});var r=o(1994),n=o(3335);function i(){for(var e=arguments.length,t=Array(e),o=0;o<e;o++)t[o]=arguments[o];return(0,n.m6)((0,r.W)(t))}function s(){{let e=localStorage.getItem("session_id");return e||(e=crypto.randomUUID(),localStorage.setItem("session_id",e),localStorage.setItem("session_created",Date.now().toString())),e}}function a(e,t){let o=t||e.sessionId||s(),r={...e,sessionId:o,timestamp:Date.now()},n=l(),i=n.findIndex(e=>e.moduleId===r.moduleId);i>=0?(r.sessionId=n[i].sessionId,n[i]=r):n.push(r),localStorage.setItem("vote_history",JSON.stringify(n))}function l(){try{let e=localStorage.getItem("vote_history");return e?JSON.parse(e):[]}catch(e){return console.error("读取本地投票历史失败:",e),[]}}function u(e){return l().find(t=>t.moduleId===e)||null}function d(e){return null!==u(e)}function c(e){let t=l().filter(t=>t.moduleId!==e);localStorage.setItem("vote_history",JSON.stringify(t))}function g(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30,t=Date.now()-864e5*e,o=l().filter(e=>e.timestamp>t);localStorage.setItem("vote_history",JSON.stringify(o))}function f(){let e=l(),t=e.length,o=new Set(e.map(e=>e.moduleId)).size,r=e.length>0?Math.min(...e.map(e=>e.timestamp)):null;return{totalVotes:t,uniqueModules:o,oldestVote:r?new Date(r):null,sessionId:s()}}function m(e){return new Date(e).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"})}function y(e){return new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function h(e,t){return 0===t?0:Math.round(e/t*100)}},2893:function(e,t,o){o.d(t,{LM:function(){return i.useUserStore},Lb:function(){return n.useVotingStore},kI:function(){return r.useModulesStore}});var r=o(8927),n=o(1378),i=o(9541)},8927:function(e,t,o){o.r(t),o.d(t,{useModulesStore:function(){return i}});var r=o(4483);let n={modules:[],pagination:{page:1,limit:20,total:0,totalPages:0},searchQuery:"",loading:!1,error:null},i=(0,r.Ue)((e,t)=>({...n,setModules:t=>e({modules:t}),setPagination:t=>e({pagination:t}),setSearchQuery:t=>e({searchQuery:t}),setLoading:t=>e({loading:t}),setError:t=>e({error:t}),fetchModules:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",{setLoading:r,setError:n,setModules:i,setPagination:s}=t();r(!0),n(null);try{let t=new URLSearchParams({page:e.toString(),limit:"20"});o.trim()&&t.append("search",o.trim());let r=await fetch("/api/modules?".concat(t.toString()));if(!r.ok)throw Error("获取模组列表失败");let n=await r.json();i(n.modules),s(n.pagination)}catch(e){n(e instanceof Error?e.message:"未知错误"),i([])}finally{r(!1)}},searchModules:async e=>{let{setSearchQuery:o,setPagination:r,fetchModules:n}=t();o(e),r({...t().pagination,page:1}),await n(1,e)},goToPage:async e=>{let{setPagination:o,fetchModules:r,searchQuery:n}=t();o({...t().pagination,page:e}),await r(e,n)},refresh:async()=>{let{pagination:e,searchQuery:o,fetchModules:r}=t();await r(e.page,o)},reset:()=>e(n)}))},9541:function(e,t,o){o.r(t),o.d(t,{useUserStore:function(){return s}});var r=o(4483),n=o(3448);let i={isAuthenticated:!1,userId:null,username:null,email:null,voteHistory:[],voteStats:{totalVotes:0,uniqueModules:0,oldestVote:null,sessionId:""},historyLoading:!1},s=(0,r.Ue)((e,t)=>({...i,setAuthenticated:t=>e({isAuthenticated:t}),setUser:t=>e({isAuthenticated:!!t,userId:(null==t?void 0:t.id)||null,username:(null==t?void 0:t.username)||null,email:(null==t?void 0:t.email)||null}),setVoteHistory:t=>e({voteHistory:t}),addVoteToHistory:o=>{let{voteHistory:r}=t(),n=r.findIndex(e=>e.moduleId===o.moduleId);if(n>=0){let t=[...r];t[n]=o,e({voteHistory:t})}else e({voteHistory:[...r,o]})},removeVoteFromHistory:o=>{let{voteHistory:r}=t();e({voteHistory:r.filter(e=>e.moduleId!==o)})},clearVoteHistory:()=>e({voteHistory:[]}),loadVoteHistory:()=>{e({historyLoading:!0});try{let t=(0,n.mJ)(),o=(0,n.AC)();e({voteHistory:t,voteStats:o,historyLoading:!1})}catch(t){console.error("加载本地投票历史失败:",t),e({historyLoading:!1})}},removeVote:e=>{(0,n.u3)(e);let{loadVoteHistory:o}=t();o()},cleanupOldData:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;(0,n.Sp)(e);let{loadVoteHistory:o}=t();o()},reset:()=>e(i)}))},1378:function(e,t,o){o.r(t),o.d(t,{useVotingStore:function(){return s}});var r=o(4483),n=o(3448);let i={selectedSubcategories:[],isSubmitting:!1,isLoadingPreviousVote:!1,hasVoted:!1,existingVote:null},s=(0,r.Ue)((e,t)=>({...i,setSelectedSubcategories:t=>e({selectedSubcategories:t}),setSubmitting:t=>e({isSubmitting:t}),setLoadingPreviousVote:t=>e({isLoadingPreviousVote:t}),setHasVoted:t=>e({hasVoted:t}),setExistingVote:t=>e({existingVote:t}),toggleSubcategory:o=>{let{selectedSubcategories:r}=t();e({selectedSubcategories:r.includes(o)?r.filter(e=>e!==o):[...r,o]})},loadPreviousVote:async e=>{let{setLoadingPreviousVote:o,setExistingVote:r,setSelectedSubcategories:i}=t(),s=(0,n.tv)(e);if(s){r(s),o(!0);try{let t=await fetch("/api/tags/votes/user?module_id=".concat(e,"&session_id=").concat(s.sessionId));if(t.ok){let e=await t.json();if(Array.isArray(e)&&e.length>0){let t=e.map(e=>e.subcategory_id);i(t)}}}catch(e){console.error("获取历史投票数据失败:",e)}finally{o(!1)}}},submitVote:async(e,o,r)=>{let{selectedSubcategories:i,existingVote:s,setSubmitting:a,setHasVoted:l,setExistingVote:u,setSelectedSubcategories:d}=t();if(0===i.length)throw Error("请选择至少一个标签");a(!0);try{if(s){let t=await fetch("/api/tags/votes",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({module_id:e,session_id:s.sessionId})});if(!t.ok){let e=await t.json();throw Error(e.error||"删除旧投票记录失败")}(0,n.u3)(e)}let t=(null==s?void 0:s.sessionId)||(0,n.xv)(),a=await fetch("/api/tags/votes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({module_id:e,subcategory_ids:i,session_id:t})});if(!a.ok){let e=await a.json();throw Error(e.error||"投票提交失败")}let c=r.filter(e=>i.includes(e.id)),g=c.map(e=>{var t;return null===(t=e.category)||void 0===t?void 0:t.name}).filter(e=>!!e),f=Array.from(new Set(g)),m={moduleId:e,moduleName:o,subcategoryIds:i,subcategoryNames:c.map(e=>e.name),categoryName:f.join(", "),sessionId:t};return(0,n.j2)(m),l(!0),u({...m,sessionId:t,timestamp:Date.now()}),d([]),await a.json()}catch(e){throw console.error("投票提交失败:",e),e}finally{a(!1)}},revote:async e=>{let{existingVote:o,setSubmitting:r,setHasVoted:n,setExistingVote:i,setSelectedSubcategories:s}=t();if(o){r(!0);try{let r=await fetch("/api/tags/votes",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({module_id:e,session_id:o.sessionId})});if(!r.ok){let e=await r.json();throw Error(e.error||"删除投票记录失败")}let a=o.subcategoryIds||[],l=JSON.parse(localStorage.getItem("userVoteHistory")||"[]").filter(t=>!(t.moduleId===e&&t.sessionId===o.sessionId));localStorage.setItem("userVoteHistory",JSON.stringify(l)),n(!1),i(null),0===t().selectedSubcategories.length&&a.length>0&&s(a)}catch(e){console.error("重新投票失败:",e),alert(e instanceof Error?e.message:"重新投票失败")}finally{r(!1)}}},reset:()=>e(i)}))}}]);